/**
 * ------------------------------------------------------------
 * Copyright (c) All rights reserved
 * SiLab, Institute of Physics, University of Bonn
 * ------------------------------------------------------------
 */
`timescale 1ps / 1ps
`default_nettype none

module ddrvfifo
#(
    parameter   BASEADDR = 32'h0000,
    parameter   HIGHADDR = 32'h0000,
    parameter   ABUSWIDTH = 16,

    parameter   BASEADDR_DATA = 64'h0001000000000000,
    parameter   HIGHADDR_DATA = 64'h000f000000000000,

    parameter   DEPTH = 32'h8000
) (
    input wire                  BUS_CLK,
    input wire                  BUS_RST,
    input wire [ABUSWIDTH-1:0]  BUS_ADD,
    inout wire [7:0]            BUS_DATA,
    input wire                  BUS_RD,
    input wire                  BUS_WR,

    output wire 				EMPTY,
    output wire 				FULL,
    output wire [31:0]          DATA_OUT,
    input wire [31:0]           DATA_IN,
    input wire                  READ,
    input wire                  WRITE,
    input wire					TLAST,

    input wire                  VFIFO_RESET,
	input wire					DDR_CLK_P, DDR_CLK_N,

    output wire [14:0] ddr3_addr,   // output [14:0]	ddr3_addr
    output wire [2:0] ddr3_ba,      // output [2:0]		ddr3_ba
    output wire ddr3_cas_n,         // output			ddr3_cas_n
    output wire [0:0] ddr3_ck_n,    // output [0:0]		ddr3_ck_n
    output wire [0:0] ddr3_ck_p,    // output [0:0]		ddr3_ck_p
    output wire [0:0] ddr3_cke,     // output [0:0]		ddr3_cke
    output wire ddr3_ras_n,         // output			ddr3_ras_n
    output wire ddr3_reset_n,       // output			ddr3_reset_n
    output wire ddr3_we_n,          // output			ddr3_we_n
    inout wire [7:0] ddr3_dq,       // inout [7:0]		ddr3_dq
    inout wire [0:0] ddr3_dqs_n,    // inout [0:0]		ddr3_dqs_n
    inout wire [0:0] ddr3_dqs_p,    // inout [0:0]		ddr3_dqs_p
	output wire [0:0] ddr3_cs_n,    // output [0:0]		ddr3_cs_n
    output wire [0:0] ddr3_dm,      // output [0:0]		ddr3_dm
    output wire [0:0] ddr3_odt,     // output [0:0]		ddr3_odt
    output wire init_calib_complete // output			init_calib_complete
);


wire IP_RD, IP_WR;
wire [ABUSWIDTH-1:0] IP_ADD;
wire [7:0] IP_DATA_IN;
wire [7:0] IP_DATA_OUT;
wire VALID;


/*
//DDRVFIFO interface
wire        VFIFO_EMPTY;
wire        VFIFO_FULL;
wire [31:0] VFIFO_DATA_OUT;
wire [31:0] VFIFO_DATA_IN;
wire        VFIFO_READ;
wire        VFIFO_WRITE;
*/


bus_to_ip #(
    .BASEADDR(BASEADDR),
    .HIGHADDR(HIGHADDR),
    .ABUSWIDTH(ABUSWIDTH))
i_bus_to_ip_vfifo
(
    .BUS_RD(BUS_RD),
    .BUS_WR(BUS_WR),
    .BUS_ADD(BUS_ADD),
    .BUS_DATA(BUS_DATA),

    .IP_RD(IP_RD),
    .IP_WR(IP_WR),
    .IP_ADD(IP_ADD),
    .IP_DATA_IN(IP_DATA_IN),
    .IP_DATA_OUT(IP_DATA_OUT)
);


ddrvfifo_core
#(
    .DEPTH(DEPTH)
//    .FIFO_ALMOST_FULL_THRESHOLD(FIFO_ALMOST_FULL_THRESHOLD),
//    .FIFO_ALMOST_EMPTY_THRESHOLD(FIFO_ALMOST_EMPTY_THRESHOLD),
//    .ABUSWIDTH(ABUSWIDTH)
)
i_ddrvfifo_core
(
    .BUS_CLK(BUS_CLK),
    .BUS_RST(BUS_RST),
    .BUS_ADD(IP_ADD),
    .BUS_DATA_IN(IP_DATA_IN),
    .BUS_RD(IP_RD),
    .BUS_WR(IP_WR),
    .BUS_DATA_OUT(IP_DATA_OUT),

    .INIT_DONE(init_calib_complete),
    .VALID(VALID)
/*    ,

    .EMPTY(),//EMPTY
    .FULL(),//FULL
    .DATA_OUT(),//DATA_OUT
    .DATA_IN(DATA_IN),
    .READ(READ),
    .WRITE(WRITE)
*/
);

wire [1:0] mm2s_channel_full = 2'b00;
wire [1:0] mm2s_channel_empty;
wire [1:0] s2mm_channel_full;
wire [1:0] vfifo_idle;


//write to fifo
wire s_axis_tvalid = 1'b0;
wire s_axis_tready;
wire s_axis_tlast = TLAST;
wire [31:0] s_axis_tdata = 32'd0;

//read from fifo
wire m_axis_tvalid;
wire m_axis_t_ready = 1'b0;
wire [31:0] m_axis_tdata;

/*
    wire ddr_init_done;
    wire vfifo_data_out_valid;
    wire vfifo_empty;
    wire vfifo_full;
    wire [31:0] vfifo_data_out;

    simplified_tb
    i_simplified_tb(
        .start_veto(1'b0),//VFIFO_RESET
        .ddr_init_done(ddr_init_done),
        .vfifo_data_out_valid(vfifo_data_out_valid),
        .vfifo_empty(vfifo_empty),
        .vfifo_full(vfifo_full),
        .vfifo_data_out(vfifo_data_out)
    );
*/


axi_ddrvfifo
#(
)
i_axi_ddrvfifo
(
    .aclk(BUS_CLK),
    .aresetn(!VFIFO_RESET),
    .sys_clk_p(DDR_CLK_P),
    .sys_clk_n(DDR_CLK_N),

    .read(READ),
    .write(WRITE),
    .data_in(DATA_IN),
    .data_out(DATA_OUT),
    .empty(EMPTY),
    .full(FULL),

    .ext_vfifo_mm2s_channel_full(mm2s_channel_full),
    .ext_vfifo_s2mm_channel_full(s2mm_channel_full),
    .ext_vfifo_mm2s_channel_empty(mm2s_channel_empty),
    .ext_vfifo_idle(vfifo_idle),

    .ext_s_axis_tvalid(s_axis_tvalid),
    .ext_s_axis_tready(s_axis_tready),
    .ext_s_axis_tdata(s_axis_tdata),
    .ext_s_axis_tlast(s_axis_tlast),

    .ext_m_axis_tvalid(m_axis_tvalid),
    .ext_m_axis_tready(m_axis_t_ready),
    .ext_m_axis_tdata(m_axis_tdata),
    .ext_m_axis_tlast(m_axis_tlast),

    // Memory interface ports
    .ddr3_addr(ddr3_addr),
    .ddr3_ba(ddr3_ba),
    .ddr3_cas_n(ddr3_cas_n),
    .ddr3_ck_n(ddr3_ck_n),
    .ddr3_ck_p(ddr3_ck_p),
    .ddr3_cke(ddr3_cke),
    .ddr3_ras_n(ddr3_ras_n),
    .ddr3_reset_n(ddr3_reset_n),
    .ddr3_we_n(ddr3_we_n),
    .ddr3_dq(ddr3_dq),
    .ddr3_dqs_n(ddr3_dqs_n),
    .ddr3_dqs_p(ddr3_dqs_p),
    .init_calib_complete(init_calib_complete),
	.ddr3_cs_n(ddr3_cs_n),
    .ddr3_dm(ddr3_dm),
    .ddr3_odt(ddr3_odt)
);

assign VALID = m_axis_tvalid;// && !EMPTY;

endmodule
